<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>

# Sync 模块

一旦我所属的文件夹有所变化，请更新我。

## 架构概述

移动端实时同步层，负责 WebSocket 通信、状态管理和端到端加密。

## 文件清单

| 文件 | 地位 | 功能 |
|------|------|------|
| `sync.ts` | 核心 | WebSocket 客户端，消息收发，状态同步 reducer |
| `ackManager.ts` | 可靠性 | ACK 确认机制，消息重试逻辑（5秒超时，最多3次重试） |
| `offlineCache.ts` | 离线 | 离线缓存管理，LRU 淘汰策略（100条消息/100MB限制） |
| `apiTypes.ts` | 契约 | 服务器 API 更新事件类型定义 (Zod schemas) |
| `rpcTypes.ts` | 契约 | 远程控制 RPC 请求/响应类型定义 |
| `types.ts` | 契约 | 内部状态类型定义 (Session, Message 等) |
| `storageTypes.ts` | 契约 | 本地存储类型定义 |
| `profile.ts` | 数据 | 用户档案解析和验证 |
| `settings.ts` | 数据 | 设置解析和默认值 |
| `localSettings.ts` | 数据 | 本地设置管理 |
| `purchases.ts` | 数据 | 购买记录解析 |
| `typesRaw.ts` | 转换 | 原始消息归一化转换 |
| `friendTypes.ts` | 契约 | 好友关系类型定义 |
| `apiFriends.ts` | API | 好友 REST API 客户端 |
| `feedTypes.ts` | 契约 | 动态流类型定义 |
| `apiFeed.ts` | API | 动态流 REST API 客户端 |
| `encryption/` | 加密 | E2E 加密工具 (session, machine, message) |

## Phase 5: Session Fork

- `storageTypes.ts#Session`: 新增 `forkedFromSessionId`, `forkPointMessageId`, `forkCount` 字段
- `apiTypes.ts#ApiUpdateForkSessionSchema`: fork-session 事件类型定义
- `sync.ts#handleUpdate`: 处理 fork-session 实时事件，解密并添加新 session